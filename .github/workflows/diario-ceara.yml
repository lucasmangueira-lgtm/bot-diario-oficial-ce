name: Bot Diario Oficial CE

on:
  schedule:
    - cron: "0 */20 * * *"  # 20h00, 20h20, 20h40, 21h00... UTC
  workflow_dispatch: {}

jobs:
  check-doe:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # para commit do state.json

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Rodar checker
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python checker.py

      - name: Commit state.json atualizado (se mudou)
        run: |
          if [ -f state.json ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add state.json
            git diff --staged --quiet || git commit -m "Update state.json [skip ci]"
            git push
          fi
